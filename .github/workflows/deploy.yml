name: "Deploy"

on:
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

jobs:
  build-agent:
    name: "Build Agent Lambda"
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: ./src/agent

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Setup Zig
        uses: mlugg/setup-zig@v2

      - name: Setup Cargo Lambda
        run: pip3 install cargo-lambda

      - name: Cache Dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src/agent

      - name: Format
        run: cargo fmt --all -- --check

      - name: Lint
        run: cargo clippy --all-targets --all-features -- -D warnings

      - name: Build
        run: cargo lambda build --release --arm64

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: agent-lambda
          path: ./src/agent/target/lambda/agent-lambda/
          retention-days: 1

  build-post-create:
    name: "Build Post Create Lambda"
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: ./src/post_create

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Setup Zig
        uses: mlugg/setup-zig@v2

      - name: Setup Cargo Lambda
        run: pip3 install cargo-lambda

      - name: Cache Dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src/post_create

      - name: Format
        run: cargo fmt --all -- --check

      - name: Lint
        run: cargo clippy --all-targets --all-features -- -D warnings

      - name: Build
        run: cargo lambda build --release --arm64

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: post-create-lambda
          path: ./src/post_create/target/lambda/post-create-lambda/
          retention-days: 1

  build-scheduling:
    name: "Build Scheduling Lambda"
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: ./src/scheduling

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Setup Zig
        uses: mlugg/setup-zig@v2

      - name: Setup Cargo Lambda
        run: pip3 install cargo-lambda

      - name: Cache Dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src/scheduling

      - name: Format
        run: cargo fmt --all -- --check

      - name: Lint
        run: cargo clippy --all-targets --all-features -- -D warnings

      - name: Build
        run: cargo lambda build --release --arm64

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: scheduling-lambda
          path: ./src/scheduling/target/lambda/scheduling-lambda/
          retention-days: 1

  build-webhook-sync:
    name: "Build Webhook Sync Lambda"
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: ./src/webhook_sync

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Setup Zig
        uses: mlugg/setup-zig@v2

      - name: Setup Cargo Lambda
        run: pip3 install cargo-lambda

      - name: Cache Dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src/webhook_sync

      - name: Format
        run: cargo fmt --all -- --check

      - name: Lint
        run: cargo clippy --all-targets --all-features -- -D warnings

      - name: Build
        run: cargo lambda build --release --arm64

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: webhook-sync-lambda
          path: ./src/webhook_sync/target/lambda/webhook-sync-lambda/
          retention-days: 1

  plan:
    name: "Terraform Plan"
    runs-on: ubuntu-latest
    needs:
      [build-agent, build-post-create, build-scheduling, build-webhook-sync]

    defaults:
      run:
        working-directory: ./terraform

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download Agent Function Artifact
        uses: actions/download-artifact@v4
        with:
          name: agent-lambda
          path: ./agent-lambda

      - name: Download Post Create Function Artifact
        uses: actions/download-artifact@v4
        with:
          name: post-create-lambda
          path: ./post-create-lambda

      - name: Download Scheduling Function Artifact
        uses: actions/download-artifact@v4
        with:
          name: scheduling-lambda
          path: ./scheduling-lambda

      - name: Download Webhook Sync Function Artifact
        uses: actions/download-artifact@v4
        with:
          name: webhook-sync-lambda
          path: ./webhook-sync-lambda

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "~1.13"

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          mask-aws-account-id: true
          aws-region: us-east-1

      - name: Terraform Format
        id: fmt
        run: terraform fmt -check

      - name: Terraform Init
        id: init
        run: terraform init

      - name: Terraform Validate
        id: validate
        run: terraform validate -no-color

      - name: Terraform Plan
        id: plan
        run: terraform plan -no-color -input=false

  apply:
    name: "Terraform Apply"
    runs-on: ubuntu-latest
    environment: production
    needs: [plan]

    defaults:
      run:
        working-directory: ./terraform

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download Agent Function Artifact
        uses: actions/download-artifact@v4
        with:
          name: agent-lambda
          path: ./agent-lambda

      - name: Download Post Create Function Artifact
        uses: actions/download-artifact@v4
        with:
          name: post-create-lambda
          path: ./post-create-lambda

      - name: Download Scheduling Function Artifact
        uses: actions/download-artifact@v4
        with:
          name: scheduling-lambda
          path: ./scheduling-lambda

      - name: Download Webhook Sync Function Artifact
        uses: actions/download-artifact@v4
        with:
          name: webhook-sync-lambda
          path: ./webhook-sync-lambda

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "~1.13"

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          mask-aws-account-id: true
          aws-region: us-east-1

      - name: Terraform Init
        id: init
        run: terraform init

      - name: Terraform Apply
        id: apply
        run: terraform apply -auto-approve -input=false
